<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>CV Libre – Glisser-déposer + Correction</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  font-family: "Segoe UI", sans-serif;
  background: #f4f4f8;
  display: flex;
  gap: 20px;
  padding: 20px;
  box-sizing: border-box;
}

/* Colonne des éléments (fixe) */
#elements {
  width: 28%;
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
  height: 90vh;
  overflow-y: auto;
  box-sizing: border-box;
  position: sticky;
  top: 20px;
}

#elements h2 {
  font-size: 18px;
  margin-top: 0;
}

.draggable {
  padding: 6px 10px;
  margin-bottom: 8px;
  background: #e8ecf7;
  border-radius: 6px;
  cursor: grab;
  border: 1px solid #cdd5ea;
  font-size: 12px;
}

/* Zone de droite (scrollable) */
#right {
  display: flex;
  flex-direction: column;
  gap: 10px;
  flex: 1;
  height: 90vh;
  overflow-y: auto;
}

/* Consigne + boutons */
#top-bar {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
}

#instruction {
  background: #ffffff;
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: 0 0 8px rgba(0,0,0,0.08);
  font-size: 14px;
  line-height: 1.4;
  flex: 1;
}

#buttons {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

button {
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-size: 13px;
}

#resetBtn {
  background: #f44336;
  color: white;
}

#pdfBtn {
  background: #4a7dfc;
  color: white;
}

#correctBtn {
  background: #4caf50;
  color: white;
  display: none;
}

/* Feuille blanche */
#canvas-wrapper {
  margin-top: 10px;
}

#canvas {
  width: 800px;
  height: 1100px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 0 12px rgba(0,0,0,0.15);
  position: relative;
  overflow: hidden;
  box-sizing: border-box;

  /* --- GRILLE ULTRA-LÉGÈRE (Option D) --- */
  background-image:
    linear-gradient(to right, rgba(0,0,0,0.03) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(0,0,0,0.03) 1px, transparent 1px);
  background-size: 40px 40px;
}

/* Éléments déposés */
.dropped {
  position: absolute;
  padding: 6px 10px;
  background: #fff8d6;
  border: 1px solid #e0c96d;
  border-radius: 6px;
  font-size: 12px;
  cursor: move;
  white-space: nowrap;
}

/* Correction */
.correct {
  background: #d4ffd4 !important;
  border-color: #4caf50 !important;
}

.incorrect {
  background: #ffd4d4 !important;
  border-color: #f44336 !important;
}
</style>
</head>

<body>

<!-- Éléments à glisser -->
<div id="elements">
  <h2>Éléments du CV</h2>

  <!-- Rubriques principales -->
  <div class="draggable" draggable="true">Compétences</div>
  <div class="draggable" draggable="true">Expériences professionnelles</div>
  <div class="draggable" draggable="true">Formations</div>
  <div class="draggable" draggable="true">Centres d’intérêts</div>
  <div class="draggable" draggable="true">Informations complémentaires</div>

  <!-- Identité -->
  <div class="draggable" draggable="true">Photo</div>
  <div class="draggable" draggable="true">Nom / Prénom</div>
  <div class="draggable" draggable="true">Titre du CV</div>
  <div class="draggable" draggable="true">Adresse</div>
  <div class="draggable" draggable="true">Code postal + Ville</div>
  <div class="draggable" draggable="true">Téléphone</div>
  <div class="draggable" draggable="true">Adresse Email</div>
  <div class="draggable" draggable="true">Permis + véhicule</div>
  <div class="draggable" draggable="true">Âge / Date de naissance</div>
  <div class="draggable" draggable="true">Situation familiale</div>
  <div class="draggable" draggable="true">Nationalité</div>

  <!-- Compétences -->
  <div class="draggable" draggable="true">Techniques</div>
  <div class="draggable" draggable="true">Informatiques</div>
  <div class="draggable" draggable="true">Commerciales</div>
  <div class="draggable" draggable="true">Administratives</div>
  <div class="draggable" draggable="true">Savoirs-être</div>

  <!-- Expériences -->
  <div class="draggable" draggable="true">Dates</div>
  <div class="draggable" draggable="true">Intitulé du poste</div>
  <div class="draggable" draggable="true">Entreprise</div>
  <div class="draggable" draggable="true">Ville (expérience)</div>
  <div class="draggable" draggable="true">Tâches / missions</div>

  <!-- Formations -->
  <div class="draggable" draggable="true">Année d’obtention</div>
  <div class="draggable" draggable="true">Diplôme obtenu</div>
  <div class="draggable" draggable="true">Établissement</div>
  <div class="draggable" draggable="true">Ville (formation)</div>

  <!-- Infos complémentaires -->
  <div class="draggable" draggable="true">Langues étrangères</div>
  <div class="draggable" draggable="true">Activité associative</div>
  <div class="draggable" draggable="true">Autres informations</div>
</div>

<!-- Partie droite -->
<div id="right">
  <div id="top-bar">
    <div id="instruction">
      <strong>Consigne :</strong><br>
      Glissez-déposez les éléments du CV sur la feuille blanche ci-dessous.<br>
      Placez chaque information et chaque rubrique à l’endroit où, selon vous, elle devrait apparaître sur un CV professionnel.<br>
      Vous pouvez déplacer les éléments déposés pour ajuster votre mise en page.
    </div>
    <div id="buttons">
      <button id="resetBtn">Réinitialiser</button>
      <button id="pdfBtn">Exporter PDF</button>
      <button id="correctBtn">Afficher la correction</button>
    </div>
  </div>

  <div id="canvas-wrapper">
    <div id="canvas"></div>
  </div>
</div>

<script>
let dragged = null;

/* --- Mélanger l'ordre des éléments --- */
function shuffleDraggables() {
  const container = document.getElementById('elements');
  const items = Array.from(container.querySelectorAll('.draggable'));

  for (let i = items.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [items[i], items[j]] = [items[j], items[i]];
  }

  items.forEach(item => container.appendChild(item));
}
shuffleDraggables();

/* --- DRAG DEPUIS LA COLONNE DE GAUCHE --- */
document.querySelectorAll('.draggable').forEach(el => {
  el.addEventListener('dragstart', () => {
    dragged = el;
  });
});

const canvas = document.getElementById('canvas');

canvas.addEventListener('dragover', e => {
  e.preventDefault();
});

canvas.addEventListener('drop', e => {
  e.preventDefault();
  if (!dragged) return;

  const rect = canvas.getBoundingClientRect();

  dragged.classList.add("dropped");
  dragged.style.position = "absolute";
  dragged.style.left = (e.clientX - rect.left) + "px";
  dragged.style.top = (e.clientY - rect.top) + "px";

  canvas.appendChild(dragged);

  enableInternalDrag(dragged);

  dragged = null;

  checkIfAllPlaced();
});

/* --- DÉPLACEMENT INTERNE ULTRA-STABLE --- */
function enableInternalDrag(el) {
  el.addEventListener('pointerdown', e => {
    e.preventDefault();

    const rect = el.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();

    const offsetX = e.clientX - rect.left;
    const offsetY = e.clientY - rect.top;

    function move(e) {
      el.style.left = (e.clientX - canvasRect.left - offsetX) + "px";
      el.style.top = (e.clientY - canvasRect.top - offsetY) + "px";
    }

    function stop() {
      document.removeEventListener('pointermove', move);
      document.removeEventListener('pointerup', stop);
    }

    document.addEventListener('pointermove', move);
    document.addEventListener('pointerup', stop);
  });
}

/* --- AFFICHAGE DU BOUTON DE CORRECTION --- */
function checkIfAllPlaced() {
  const remaining = document.querySelectorAll('.draggable:not(.dropped)').length;
  if (remaining === 0) {
    document.getElementById('correctBtn').style.display = "block";
  }
}

/* --- RÉINITIALISATION --- */
document.getElementById('resetBtn').addEventListener('click', () => {
  location.reload();
});

/* --- EXPORT PDF (NOUVELLE VERSION FIABLE) --- */
document.getElementById('pdfBtn').addEventListener('click', () => {
  const canvas = document.getElementById('canvas');
  const win = window.open('', '_blank');

  const styles = `
    body {
      margin: 0;
      padding: 0;
      background: white;
      font-family: "Segoe UI", sans-serif;
    }
    #canvas {
      width: 800px;
      height: 1100px;
      background: white;
      position: relative;
      box-sizing: border-box;
    }
    .dropped {
      position: absolute;
      padding: 6px 10px;
      background: #fff8d6;
      border: 1px solid #e0c96d;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
    }
  `;

  win.document.write(`
    <!DOCTYPE html>
    <html lang="fr">
    <head>
      <meta charset="UTF-8">
      <title>CV Export</title>
      <style>${styles}</style>
    </head>
    <body>
      ${canvas.outerHTML}
    </body>
    </html>
  `);

  win.document.close();
  win.focus();
  win.print();
  win.close();
});

/* --- CORRECTION TOLÉRANTE --- */
document.getElementById('correctBtn').addEventListener('click', () => {
  correctCV();
});

function correctCV() {
  const tolerance = 200;

  const zones = {
    identite: { yMin: 0, yMax: 250 },
    competences: { yMin: 250, yMax: 500 },
    experiences: { yMin: 500, yMax: 800 },
    formations: { yMin: 800, yMax: 950 },
    interets: { yMin: 950, yMax: 1200 }
  };

  const mapping = {
    "Nom / Prénom": "identite",
    "Titre du CV": "identite",
    "Photo": "identite",
    "Adresse": "identite",
    "Code postal + Ville": "identite",
    "Téléphone": "identite",
    "Adresse Email": "identite",
    "Permis + véhicule": "identite",
    "Âge / Date de naissance": "identite",
    "Situation familiale": "identite",
    "Nationalité": "identite",

    "Compétences": "competences",
    "Techniques": "competences",
    "Informatiques": "competences",
    "Commerciales": "competences",
    "Administratives": "competences",
    "Savoirs-être": "competences",

    "Expériences professionnelles": "experiences",
    "Dates": "experiences",
    "Intitulé du poste": "experiences",
    "Entreprise": "experiences",
    "Ville (expérience)": "experiences",
    "Tâches / missions": "experiences",

    "Formations": "formations",
    "Année d’obtention": "formations",
    "Diplôme obtenu": "formations",
    "Établissement": "formations",
    "Ville (formation)": "formations",

    "Centres d’intérêts": "interets",
    "Informations complémentaires": "interets",
    "Langues étrangères": "interets",
    "Activité associative": "interets",
    "Autres informations": "interets"
  };

  document.querySelectorAll('.dropped').forEach(el => {
    const expected = mapping[el.textContent.trim()];
    if (!expected) return;

    const y = parseInt(el.style.top);
    const zone = zones[expected];

    if (y >= zone.yMin - tolerance && y <= zone.yMax + tolerance) {
      el.classList.add("correct");
    } else {
      el.classList.add("incorrect");
    }
  });
}
</script>

</body>
</html>
